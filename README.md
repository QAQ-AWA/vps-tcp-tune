# BBR v3 终极优化脚本 - Ultimate Edition

🚀 **XanMod 内核 + BBR v3 + 全方位 VPS 管理工具集**  
一键安装 XanMod 内核，启用 BBR v3 拥塞控制，集成 32+ 实用工具，全面优化你的 VPS 服务器。

> **版本**: 3.0.3 (iperf3 网络测试增强版)  
> **快速上手**: [📖 快速使用指南](QUICK_START.md) | **视频教程**: [🎬 B站教程](https://www.bilibili.com/video/BV14K421x7BS)

---

## 🚀 一键安装

### 方式1：快捷别名（⭐ 强烈推荐）

安装后只需输入 `bbr` 即可运行脚本（每次自动获取最新版本）：

```bash
# 安装别名
bash <(curl -fsSL "https://raw.githubusercontent.com/Eric86777/vps-tcp-tune/main/install-alias.sh?$(date +%s)")

# 重新加载配置
source ~/.bashrc  # 或 source ~/.zshrc

# 以后直接使用
bbr
```

**✨ 优势**：
- ✅ 每次运行自动获取最新版本
- ✅ 只需输入 3 个字符即可启动
- ✅ 无需记忆复杂命令
- ✅ 支持 bash 和 zsh

<details>
<summary>💡 其他安装方式（点击展开）</summary>

### 方式2：在线运行（临时使用）

```bash
# 推荐：使用时间戳参数确保获取最新版本（无缓存）
bash <(curl -fsSL "https://raw.githubusercontent.com/Eric86777/vps-tcp-tune/main/net-tcp-tune.sh?$(date +%s)")
```

**或使用 wget：**
```bash
bash <(wget -qO- "https://raw.githubusercontent.com/Eric86777/vps-tcp-tune/main/net-tcp-tune.sh?$(date +%s)")
```

### 方式3：下载到本地

```bash
wget -O net-tcp-tune.sh "https://raw.githubusercontent.com/Eric86777/vps-tcp-tune/main/net-tcp-tune.sh?$(date +%s)"
chmod +x net-tcp-tune.sh
./net-tcp-tune.sh
```

</details>

---

## 🎯 推荐调优流程

> **⚡ 经过十几二十几台服务器实测（包括酷雪云北京9929等节点）**

### 📋 首选方案（推荐）

```
步骤1：安装 BBR v3 内核 → 重启
步骤2：BBR 直连/落地优化（智能带宽检测）→ 完成
```

### 🔧 详细步骤

<details>
<summary><b>【步骤1】安装 XanMod 内核 + BBR v3</b></summary>

```bash
# 运行脚本
bbr

# 选择菜单
选择 1 → 安装 XanMod 内核 + BBR v3

# 重启生效
reboot
```

**✅ 完成后**：XanMod 内核已安装，BBR v3 已启用

</details>

<details>
<summary><b>【步骤2】BBR 直连/落地优化（智能带宽检测）</b></summary>

```bash
# 再次运行脚本
bbr

# 选择菜单
选择 2 → BBR 直连/落地优化（智能带宽检测）
      → 选择 1 → 进行自动检测

# 立即生效
```

**✅ 完成后**：BBR v3 + 智能缓冲区优化完成 🎉

</details>

### 📋 次选方案（备用）

```
步骤1：安装 BBR v3 内核 → 重启
步骤2：NS论坛CAKE调优 → 重启  
步骤3：科技lion高性能模式 → 完成
```

<details>
<summary><b>【步骤1】安装 XanMod 内核 + BBR v3</b></summary>

```bash
# 运行脚本
bbr

# 选择菜单
选择 1 → 安装 XanMod 内核 + BBR v3

# 重启生效
reboot
```

**✅ 完成后**：XanMod 内核已安装，BBR v3 已启用

</details>

<details>
<summary><b>【步骤2备选】CAKE 队列调优</b></summary>

```bash
# 再次运行脚本
bbr

# 选择菜单
选择 3 → NS论坛CAKE调优

# 重启生效
reboot
```

**✅ 完成后**：CAKE 队列算法已优化，网络延迟降低

</details>

<details>
<summary><b>【步骤3备选】Reality专用调优</b></summary>

```bash
# 再次运行脚本
bbr

# 选择菜单
选择 4 → 科技lion高性能模式
      → 选择 1 → 星辰大海ヾ优化（≥4GB内存）
      → 选择 2 → Reality终极优化（≥2GB内存，推荐）🏆
      → 选择 3 → 低配优化模式（512MB-1GB内存）💡

# 无需重启，立即生效（临时配置，重启后自动还原）
```

**✅ 完成后**：针对VLESS Reality/AnyTLS节点深度优化 🎉

**💡 三个方案对比**：
- **星辰大海** 🏆：已优化，13万文件描述符，16MB缓冲区，兼容CAKE，适合≥2GB内存
- **Reality终极**：50万文件描述符，12MB缓冲区，兼容CAKE，性能+5-10%，适合≥2GB内存
- **低配优化**：核心优化保留，6.5万文件描述符，8MB缓冲区，兼容CAKE，适合512MB-1GB内存 💡

</details>

### ⚠️ 重要提示

| 注意事项 | 说明 |
|---------|------|
| **菜单序号变化** | 安装内核前后，所有选项编号会变化（参考菜单对照表） |
| **必须重启** | 步骤1和2完成后都需要重启才能生效 |
| **按顺序执行** | 必须按照 BBR v3 → CAKE → Reality调优 的顺序 |
| **临时生效** | Reality调优默认临时生效，重启后自动还原 |

### 📊 预期优化效果

| 优化项 | 优化前 | 优化后 | 说明 |
|-------|-------|-------|------|
| **拥塞控制** | Cubic | BBR v3 | 高延迟链路性能显著提升 |
| **队列管理** | pfifo_fast | CAKE | 减少缓冲区膨胀，降低延迟 |
| **并发连接** | 128 | 4096 | 大幅提升连接处理能力 |
| **TCP缓冲区** | 默认值 | 12-16MB | 适配高带宽网络环境 |
| **文件描述符** | 1024 | 50-100万 | Reality节点深度优化 |
| **TLS握手** | 默认 | FastOpen加速 | Reality握手延迟减少50%+ |

---

## 🌟 核心特性

### ✨ 十大功能模块

1. **🔧 内核管理** - XanMod 内核安装/更新/卸载（支持 x86_64 & ARM64）
2. **⚡ BBR TCP调优** - BBR直连/落地优化（智能带宽检测）+ CAKE队列优化 + 3种Reality专用优化（覆盖512MB-8GB+所有配置）
3. **🛠️ 系统设置** - IPv4/IPv6优先级 + 虚拟内存管理 + IPv6管理（临时/永久禁用/还原） + SOCKS5代理配置 + IPv4/IPv6连接检测
4. **🔐 Xray 配置** - Realm转发分析 + **Realm强制IPv4（NEW）** + 查看/IPv6出站/恢复默认配置
5. **📊 网络测试** - Speedtest + 三网回程 + IP质量 + 延迟检测 + **iperf3单线程测试（NEW）**
6. **🎯 流媒体检测** - Netflix/Disney+/OpenAI/Claude 解锁检测
7. **🔌 第三方工具** - PF_realm + 御坂美琴 + sing-box + 科技lion + NS论坛 + 酷雪云
8. **🚀 代理部署** - 一键部署 SOCKS5 代理（基于 Sing-box） + **Sub-Store 多实例管理（NEW）**
9. **📋 系统信息** - CPU/内存/网络流量/地理位置统计

---

## 📋 功能菜单

<details>
<summary>📊 完整菜单对照表（点击展开）</summary>

| 功能 | 未安装内核 | 已安装内核 |
|------|-----------|-----------|
| 安装/更新内核 | 1 | 1（更新） |
| 卸载内核 | - | 2 |
| **BBR直连/落地** | **2** | **3** |
| **NS论坛CAKE调优** | **3** | **4** |
| **科技lion高性能模式** | **4** | **5** |
| **IPv4/IPv6优先级** | **5** | **6** |
| **虚拟内存管理** | **6** | **7** |
| **IPv6管理** | **7** | **8** |
| **临时SOCKS5代理** | **8** | **9** |
| IPv4/IPv6连接检测 | 9 | 10 |
| Realm转发分析 | 10 | 11 |
| **Realm强制IPv4** | **11** | **12** |
| 查看Xray配置 | 12 | 13 |
| Xray IPv6出站 | 13 | 14 |
| 恢复Xray默认 | 14 | 15 |
| 查看详细状态 | 15 | 16 |
| NS一键检测 | 16 | 17 |
| 服务器带宽测试 | 17 | 18 |
| 三网回程路由 | 18 | 19 |
| IP质量检测 | 19 | 20 |
| IP质量-IPv4 | 20 | 21 |
| 网络延迟检测 | 21 | 22 |
| 国际互联速度 | 22 | 23 |
| **iperf3单线程测试** | **23** | **24** |
| 媒体/AI解锁 | 24 | 25 |
| PF_realm转发 | 25 | 26 |
| 御坂美琴双协议 | 26 | 27 |
| F佬sing box | 27 | 28 |
| 科技lion脚本 | 28 | 29 |
| NS论坛cake调优 | 29 | 30 |
| 酷雪云脚本 | 30 | 31 |
| 部署SOCKS5代理 | 31 | 32 |
| **Sub-Store多实例管理** | **32** | **33** |

</details>

---

## 📋 支持系统

| 系统 | 架构 | 支持状态 |
|------|------|---------|
| **Debian 10+** | x86_64 | ✅ 完整支持 |
| **Ubuntu 20.04+** | x86_64 | ✅ 完整支持 |
| **Debian/Ubuntu** | ARM64 | ✅ 专用脚本 |
| 其他发行版 | - | ❌ 不支持 |

---

## 📊 验证配置

```bash
# 查看拥塞控制算法
sysctl net.ipv4.tcp_congestion_control

# 查看队列算法
sysctl net.core.default_qdisc

# 验证 BBR 版本
modinfo tcp_bbr | grep version
```

**预期输出**：
```
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = cake
version:        3
```

---

## 🔧 高级功能说明

<details>
<summary>🔍 Realm 转发连接分析</summary>

**核心功能**：
- 🔍 自动检测 Realm 进程
- 📊 智能分析所有转发源 IP
- 🌐 自动查询 IP 归属地（国家/城市/ISP/AS号）
- ✅ 精确识别 IPv4/IPv6 协议类型
- 📈 实时统计连接数和协议分布

**菜单位置**：选项 **10**（未安装）/ **11**（已安装）

**功能亮点**：
1. **一键分析**：无需手动输入IP，自动发现所有转发源
2. **协议识别**：区分纯IPv4和IPv4映射IPv6（`::ffff:` 格式）
3. **IP溯源**：自动查询IP归属地，立即知道是谁在连接
4. **详细报告**：
   - 每个转发源的连接数
   - 本地监听端口
   - 协议类型和分布
   - 总体统计摘要

**交互功能**：
- 查看详细连接列表（所有端口详情）
- 导出分析报告到文件（保存到 `/root/realm_analysis_*.txt`）
- 实时监控模式（每5秒刷新一次）
- 检测特定源 IP（深度分析单个转发源）

**使用场景**：
- ✅ 快速确认 Realm 转发是否走 IPv4
- ✅ 发现未知的转发源（安全检查）
- ✅ 验证中转机到落地机的连接状态
- ✅ 排查连接问题（显示所有活跃连接）

**示例输出**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┌─────────────── 转发源 #1 ───────────────┐
│  源IP地址:   108.247.217.148            │
│  IP归属:     美国 加利福尼亚 DMIT        │
│  AS号:       AS54574                     │
│  连接数:     35 个                       │
│  协议类型:   ✅ 纯IPv4                   │
│  本地监听:   443                         │
│  状态:       ✅ 正常                     │
└──────────────────────────────────────────┘

统计摘要：
  • 转发源总数:     2 个
  • IPv4连接:       63 个 ✅
  • IPv6连接:       0 个
  • 结论:           100% 使用 IPv4 链路 ✅
```

**前置要求**：机器上运行有 Realm 转发服务

</details>

<details>
<summary>🔒 Realm转发强制使用IPV4</summary>

**核心功能**：
- 🔒 一键配置 Realm 转发服务强制使用 IPv4
- 💾 自动备份原始配置（支持随时还原）
- ✅ DNS + Realm配置一键修改
- 🔄 完全可逆的配置流程

**菜单位置**：选项 **11**（未安装）/ **12**（已安装）

**三大子功能**：

1. **启用 IPv4 强制转发**
   - 自动备份当前配置到 `/root/.realm_backup/`
   - 删除 IPv6 DNS 服务器（如 `2606:4700:4700::1111`）
   - 修改 Realm 配置：
     * 添加 `"resolve": "ipv4"` 强制DNS只解析IPv4
     * 将监听地址从 `:::端口` 改为 `0.0.0.0:端口`
   - 自动重启 Realm 服务
   - 显示验证结果

2. **还原到原始配置**
   - 从备份恢复 `/etc/resolv.conf`
   - 从备份恢复 `/etc/realm/config.json`
   - 自动重启 Realm 服务
   - 完全恢复到修改前的状态

3. **查看详细配置**
   - 显示当前 DNS 配置
   - 显示 Realm 配置文件
   - 显示 Realm 监听端口状态

**配置变更示例**：

DNS配置变更：
```
修改前：
nameserver 1.1.1.1
nameserver 2606:4700:4700::1111  ← IPv6 DNS

修改后：
nameserver 1.1.1.1  ← 只保留 IPv4 DNS
```

Realm配置变更：
```json
修改前：
{
    "endpoints": [
        {"listen": ":::33333", "remote": "1.2.3.4:443"}
    ]
}

修改后：
{
    "resolve": "ipv4",  ← 新增：强制IPv4解析
    "endpoints": [
        {"listen": "0.0.0.0:33333", "remote": "1.2.3.4:443"}
                    ↑ IPv4监听
    ]
}
```

**验证方法**：
```bash
# 查看监听端口（应该只显示 0.0.0.0:端口）
ss -tlnp | grep realm

# 查看DNS配置（不应有IPv6地址）
grep nameserver /etc/resolv.conf

# 查看Realm配置
cat /etc/realm/config.json
```

**使用场景**：
- ✅ 确保 Realm 转发百分之百走 IPv4
- ✅ 解决 IPv6 连接不稳定问题
- ✅ 测试 IPv4 vs IPv6 性能对比
- ✅ 快速切换并可随时还原

**安全机制**：
- ✅ 修改前强制备份
- ✅ 备份文件独立存储（`/root/.realm_backup/`）
- ✅ 已有备份时提示确认覆盖
- ✅ 还原前二次确认
- ✅ JSON格式自动验证

**前置要求**：
- 机器上运行有 Realm 转发服务
- Realm 服务由 systemd 管理
- 配置文件位于 `/etc/realm/config.json`

</details>

<details>
<summary>🧠 虚拟内存智能计算</summary>

**菜单位置**：选项 **6**（未安装）/ **7**（已安装）

> ℹ️ **说明**：脚本仅创建和管理 `/swapfile`，不会自动修改 `/dev/*` 分区。如需调整磁盘分区类型的 SWAP，请手动处理。

| 物理内存 | 推荐 SWAP | 计算公式 |
|---------|-----------|---------|
| < 512MB | 1GB（固定） | 固定值 |
| 512MB - 1GB | 内存 × 2 | 例：512MB → 1GB SWAP |
| 1GB - 2GB | 内存 × 1.5 | 例：1GB → 1.5GB SWAP |
| 2GB - 4GB | 内存 × 1 | 例：2GB → 2GB SWAP |
| 4GB - 8GB | 4GB（固定） | 固定值 |
| ≥ 8GB | 4GB（固定） | 固定值 |

</details>

<details>
<summary>🎯 Debian12 智能调优（BDP自适应+内存保护）</summary>

**已移除**：此功能在当前版本已不存在

**核心特性**：
- 🧠 **智能 BDP 计算**：根据带宽和延迟自动计算最优缓冲区大小
- 🛡️ **内存保护机制**：缓冲区大小不超过系统内存的 10%，避免 OOM
- 🌐 **自动网络检测**：ping 公网 DNS (8.8.8.8) 获取真实 RTT
- 🔧 **冲突清理**：自动备份并清理旧配置，避免参数冲突
- ✅ **安全验证**：512MB 以下内存自动拒绝，保护系统稳定性

**计算流程**：
1. 🔍 检测系统内存（< 512MB 拒绝，< 1GB 警告）
2. 🌐 检测网络延迟（ping 8.8.8.8，失败则使用 50ms）
3. 📊 计算 BDP = 带宽 × RTT / 8（默认 1000Mbps）
4. 🎯 选择合适桶值：4MB / 8MB / 16MB / 32MB / 64MB
5. 🛡️ 限制上限：不超过内存的 10%

**配置示例**（2GB 内存 + 50ms 延迟）：
```bash
# 自动计算
BDP = 1000Mbps × 50ms / 8 = 6.25MB
选择桶值 = 8MB（8388608 bytes）
内存限制 = 2048MB × 10% = 204MB ✅

# 应用配置
net.core.rmem_max = 8388608
net.core.wmem_max = 8388608
net.ipv4.tcp_rmem = 4096 87380 8388608
net.ipv4.tcp_wmem = 4096 65536 8388608
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
```

**适用场景**：
- ✅ 不确定最优参数，需要自动计算
- ✅ 多台不同配置的 VPS 批量部署
- ✅ 内存较小的 VPS（512MB-2GB）
- ✅ 追求稳定性优先

**优势对比**：

| 参数 | Debian12 智能调优 | 手动配置 |
|------|------------------|---------|
| **BDP 计算** | 自动 | 手动计算 |
| **内存保护** | ✅ 10% 上限 | ❌ 可能超限 |
| **RTT 检测** | ✅ 自动 ping | ❌ 猜测值 |
| **配置冲突** | ✅ 自动清理 | ⚠️ 手动处理 |
| **安全性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **易用性** | ⭐⭐⭐⭐⭐ | ⭐⭐ |

**注意事项**：
- ⚠️ RTT 测的是 **服务器→8.8.8.8** 的延迟，不是客户端到服务器
- ⚠️ 默认带宽 1000Mbps，可根据实际情况修改脚本
- ✅ 配置立即生效，建议重启后验证

</details>

<details>
<summary>⚡ BBR直连/落地优化（智能带宽检测）</summary>

**菜单位置**：选项 **2**（未安装）/ **3**（已安装）

**智能带宽检测流程**：
1. 🔍 选择检测方式：自动运行 speedtest / 使用通用值
2. 📊 自动提取上传带宽（Upload速度）
3. 🎯 智能计算缓冲区：
   - < 500 Mbps → 8MB
   - 500-1000 Mbps → 12MB
   - 1-2 Gbps → 16MB
   - 2-5 Gbps → 24MB
   - 5-10 Gbps → 28MB
   - > 10 Gbps → 32MB
4. ✅ 询问确认后应用配置

**特性**：
- ✅ 自动检测内存并建议SWAP配置
- ✅ TIME_WAIT重用启用（高并发）
- ✅ 端口范围1024-65535（最大化）
- ✅ 5步验证流程确保配置生效

</details>

<details>
<summary>⚙️ Reality专用内核调优（3种优化模式）</summary>

**菜单位置**：选项 **4**（未安装）/ **5**（已安装）

**3种Reality专用优化模式**：

1. **星辰大海ヾ优化模式** ⭐⭐⭐⭐⭐ (24/25分) 🏆 **推荐**
   - 已优化改进，13万文件描述符，16MB缓冲区
   - 针对VLESS Reality/AnyTLS深度优化
   - TLS握手加速 + QUIC支持 + 大并发优化
   - **兼容CAKE队列**，不覆盖用户设置
   - 修正过激参数（netdev_max_backlog: 250000→5000）
   - 适用：≥2GB内存，推荐使用
   - 特点：科学配置，CAKE兼容，稳定高效

2. **Reality终极优化** ⭐⭐⭐⭐⭐ (24/25分) 🏆 **推荐（2GB+）**
   - 基于星辰大海深度改进
   - 性能提升5-10%，资源消耗降低25%
   - 50万文件描述符，12MB缓冲区
   - 新增Reality特有优化（tcp_notsent_lowat等）
   - **兼容CAKE队列**，不覆盖用户设置
   - 适用：≥2GB内存，大多数场景
   - 特点：更科学，更平衡，更稳定

3. **低配优化模式** ⭐⭐⭐⭐ (20/25分) 💡 **推荐（1GB）**
   - 核心优化保留，资源消耗最低
   - 6.5万文件描述符，8MB缓冲区
   - BBR + FastOpen + slow_start_after_idle=0
   - **兼容CAKE队列**，不覆盖用户设置
   - 适用：512MB-1GB内存，稳定优先
   - 特点：安全稳定，性能提升15-25%

**对比总结**：

| 参数 | 星辰大海 🏆 | Reality终极 | 低配优化 💡 |
|------|---------|------------|---------|
| **文件描述符** | 13万 | 50万 | 6.5万 |
| **TCP缓冲区** | 16MB | 12MB | 8MB |
| **内存需求** | ≥2GB | ≥2GB | 512MB-1GB |
| **swappiness** | 5 | 5 | 10 |
| **netdev_max_backlog** | 5000 ✓ | 5000 ✓ | 2500 |
| **CAKE兼容** | ✅ | ✅ | ✅ |
| **性能提升** | 优秀 | +5-10% | +15-25% |
| **稳定性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **适用场景** | ≥2GB推荐 | ≥2GB高性能 | 1GB推荐 |

**注意**：所有方案都是临时生效（重启后自动还原），适合测试和临时优化场景

</details>

<details>
<summary>🌐 IPv6 管理（临时/永久禁用/还原）</summary>

**菜单位置**：选项 **7**（未安装）/ **8**（已安装）

**三大核心功能**：

1. **临时禁用 IPv6**
   - 执行 `sysctl -w` 命令临时禁用
   - 重启后自动恢复
   - 适合临时测试场景

2. **永久禁用 IPv6**
   - ✅ **自动备份当前状态**（关键特性）
   - 创建配置文件：`/etc/sysctl.d/99-disable-ipv6.conf`
   - 创建备份文件：`/etc/sysctl.d/.ipv6-state-backup.conf`
   - 重启后仍然生效

3. **取消永久禁用（完全还原）**
   - 🎯 **从备份精确恢复到执行永久禁用前的状态**
   - 删除所有相关配置文件（配置 + 备份）
   - 确保系统恢复到"从未执行过禁用"的状态
   - 如果备份不存在，恢复到系统默认（IPv6启用）

**使用场景**：
- IPv6 连接不稳定，需要临时禁用测试
- 某些服务只支持 IPv4
- 减少 DNS 解析时间

**技术亮点**：
- ✨ 智能状态备份与还原机制
- ✨ 隐藏文件备份（`.ipv6-state-backup.conf`）
- ✨ 完全可逆的操作流程

</details>

<details>
<summary>🔌 临时 SOCKS5 代理配置</summary>

**菜单位置**：选项 **8**（未安装）/ **9**（已安装）

**功能特点**：
- 交互式输入：IP、端口、用户名（可选）、密码（可选）
- 自动生成配置文件：`/tmp/socks5_proxy_YYYYMMDD_HHMMSS.sh`
- 支持有认证和无认证两种模式
- 重启后自动失效（文件保存在 /tmp）

**使用流程**：
1. 📝 运行脚本并选择对应选项
2. 🔧 输入代理服务器信息
3. 📄 生成临时配置文件
4. ✅ 使用 `source` 命令应用代理

**应用代理**：
```bash
# 应用代理配置
source /tmp/socks5_proxy_YYYYMMDD_HHMMSS.sh

# 测试代理是否生效
curl ip.sb  # 应显示代理服务器的IP

# 取消代理
unset http_proxy https_proxy all_proxy
```

**技术说明**：
- 使用 `source` 命令在当前 shell 应用环境变量
- 配置仅对当前终端会话有效
- 关闭终端或重启后自动失效

**适用场景**：
- 临时需要通过代理访问外网
- 测试代理服务器连通性
- 下载需要代理的软件包

</details>

<details>
<summary>🌐 IPv4/IPv6 优先级设置</summary>

**菜单位置**：选项 **5**（未安装）/ **6**（已安装）

修改 `/etc/gai.conf` 配置，自动显示当前出口 IP

</details>

<details>
<summary>📊 iperf3 单线程网络测试</summary>

**菜单位置**：选项 **22**（未安装）/ **23**（已安装）

**核心功能**：
- 📡 单线程 TCP 带宽测试
- ⬆️ 上传测试（本机 → 远程服务器）
- ⬇️ 下载测试（远程服务器 → 本机）
- 🎯 自定义测试时长（1-3600秒，默认60秒）
- 📈 实时带宽显示
- 📊 智能连接质量评价

**功能特点**：
- ✅ 自动检测并安装 iperf3
- ✅ 交互式参数输入（IP/方向/时长）
- ✅ 测试前连通性检查
- ✅ 美观的结果汇总报告
- ✅ 智能重传次数评价

**使用流程**：
```bash
# 1. 在目标服务器上启动 iperf3 服务端
iperf3 -s

# 2. 在本机运行脚本并选择测试
选择 22（未安装）或 23（已安装）

# 3. 按提示输入参数
输入目标IP → 选择测试方向 → 设置测试时长
```

**测试场景**：
- ✅ **Realm中转场景**：测试前置链路（9929 → 中转机）性能
  - 上传测试：验证中转机接收能力
  - 下载测试：验证中转机推送能力
  
- ✅ **直连节点场景**：测试节点服务器（9929 → 落地节点）性能
  - 上传测试：直播推流、文件上传
  - 下载测试：视频播放、文件下载

**结果报告**：
```
[测试信息]
  目标服务器: 8.217.243.145
  测试方向: 上行（本机 → 8.217.243.145）
  测试时长: 60 秒

[性能指标]
  平均带宽: 213 Mbits/sec
  总传输量: 1.49 GBytes
  重传次数: 9352
  连接质量: 较差（重传过多）
```

**连接质量评价标准**：
- 0次重传 → 优秀（网络质量极佳）
- 1-99次 → 良好（轻微重传）
- 100-999次 → 一般（建议优化）
- ≥1000次 → 较差（需要优化）

**前置要求**：
- 目标服务器必须运行 iperf3 服务端（`iperf3 -s`）
- 防火墙开放 5201 端口

**优势对比**：
- 相比多线程测试：更准确反映单连接性能
- 相比 speedtest：可指定目标服务器，测试真实线路
- 适合场景：测试中转链路、验证配置效果

</details>

<details>
<summary>🔐 Xray 配置管理</summary>

- **查看配置**：选项 **11**（未安装）/ **12**（已安装）
- **IPv6出站**：选项 **12**（未安装）/ **13**（已安装）
- **恢复默认**：选项 **13**（未安装）/ **14**（已安装）

自动备份配置，失败自动回滚

</details>

<details>
<summary>🚀 一键部署 SOCKS5 代理（Sing-box服务）</summary>

**菜单位置**：选项 **29**（未安装）/ **30**（已安装）

基于 Sing-box 的独立 SOCKS5 代理服务，与主系统完全隔离。

**核心特性**：
- ✅ 自动检测 Sing-box
- ✅ 独立部署（服务名 `sbox-socks5`）
- ✅ 7步自动化部署流程
- ✅ 用户名密码认证
- ✅ 智能端口配置（随机/手动）
- ✅ systemd 管理

**使用示例**：
```bash
# 1. 运行脚本并选择 26/27
# 2. 按提示输入端口、用户名、密码
# 3. 测试连接
curl --socks5-hostname username:password@server_ip:port http://httpbin.org/ip
```

**服务管理**：
```bash
systemctl status sbox-socks5   # 查看状态
journalctl -u sbox-socks5 -f   # 查看日志
systemctl restart sbox-socks5  # 重启服务
```

**前置要求**：需先安装 Sing-box（推荐使用菜单中的"F佬一键sing box脚本"）

</details>

<details>
<summary>📦 Sub-Store 多实例管理</summary>

**菜单位置**：选项 **30**（未安装）/ **31**（已安装）

基于 Docker Compose 的 Sub-Store 订阅转换服务多实例管理系统。

**核心特性**：
- ✅ 多实例独立管理（支持部署多个独立的 Sub-Store 服务）
- ✅ **自定义访问路径**（支持随机生成或自定义，如 `/my-subs`）
- ✅ 端口冲突自动检测
- ✅ Docker/Docker Compose 依赖自动安装
- ✅ 完整生命周期管理（安装/更新/卸载/查看）
- ✅ 配置持久化（独立 YAML 文件）
- ✅ **自动生成 Cloudflare Tunnel 配置并引导式部署**

**架构说明**：
- 使用 `xream/sub-store:http-meta` 镜像（前后端分离架构）
- 前端端口：9876（监听 127.0.0.1）
- 后端端口：3001（监听 127.0.0.1）
- **必须通过反向代理才能访问**（无法直接通过 IP 访问）

**安装流程**：
```bash
# 1. 运行脚本并选择 Sub-Store 管理
选择 30（未安装）或 32（已安装）

# 2. 选择安装新实例
输入 1 → 安装新实例

# 3. 配置参数
实例编号: 1
后端 API 端口: 3001（回车使用默认）
HTTP-META 端口: 9876（回车使用默认）
访问路径: my-subs（或回车使用随机20位字符）
数据目录: /root/data-sub-store-1（回车使用默认）

# 4. 确认安装
脚本自动完成：
  - 创建 Docker Compose 配置
  - 启动容器
  - 生成 Cloudflare Tunnel 配置

# 5. 交互式配置向导（NEW！）
安装完成后，脚本会自动引导你配置 Cloudflare Tunnel：
  - 选择1：立即配置 Cloudflare Tunnel（推荐，全自动部署，无需开端口）
  - 选择2：跳过（稍后手动配置）
```

**访问地址格式**：
```
https://sub.你的域名.com?api=https://sub.你的域名.com/my-subs
         ↑                                       ↑
      前端页面                                后端API路径
```

**反向代理配置（交互式配置 vs 手动配置）**：

### 🎯 方案1：交互式配置向导（推荐）

安装实例后，脚本会自动进入配置向导：

**【Cloudflare Tunnel 自动化部署】**
- ✅ 自动下载并安装 `cloudflared`
- ✅ 引导登录 Cloudflare 账户
- ✅ 自动创建隧道和配置 DNS
- ✅ 生成配置文件并创建 systemd 服务
- ✅ 自动启动服务
- ✅ 完成后立即显示访问地址和管理命令

**【选项3】跳过配置**
- 生成配置模板文件供稍后手动配置

### 📝 方案2：手动配置（适合高级用户）

**【Cloudflare Tunnel 手动配置】**
```yaml
ingress:
  - hostname: sub.你的域名.com
    path: /my-subs
    service: http://127.0.0.1:3001
  - hostname: sub.你的域名.com
    service: http://127.0.0.1:9876
  - service: http_status:404
```

**自动生成的文件**：
- Docker Compose 配置：`/root/sub-store-configs/store-{实例编号}.yaml`
- CF Tunnel 配置：`/root/sub-store-cf-tunnel-{实例编号}.yaml`
- 数据目录：`/root/data-sub-store-{实例编号}/`

**常用命令**：
```bash
# 查看日志
docker logs sub-store-1

# 重启服务
docker compose -f /root/sub-store-configs/store-1.yaml restart

# 停止服务
docker compose -f /root/sub-store-configs/store-1.yaml down

# 查看容器状态
docker ps | grep sub-store
```

**多实例场景**：
- 🔹 为不同用户部署独立实例
- 🔹 测试环境与生产环境分离
- 🔹 不同订阅源使用不同实例
- 🔹 负载分散到多个实例

**前置要求**：
- 已安装 Docker 和 Docker Compose（脚本可自动安装）
- 准备好域名（用于反向代理）
- 服务器可访问 Docker Hub

**⚠️ 重要提示**：
- Sub-Store 服务监听 `127.0.0.1`，无法直接通过 IP 访问
- 必须配置 Cloudflare Tunnel 反向代理才能使用
- 访问路径支持自定义（建议使用随机路径提高安全性）
- 前端和后端共用同一端口（由 `SUB_STORE_BACKEND_API_PORT` 指定）

</details>

---

## ⚠️ 注意事项

1. **磁盘空间**：确保根分区至少有 3GB 可用空间
2. **内存要求**：低内存 VPS 会自动创建 1GB SWAP
3. **重启需求**：内核升级后必须重启才能生效
4. **兼容性**：仅支持 Debian/Ubuntu，不支持 CentOS/RHEL
5. **root 权限**：所有操作都需要 root 权限

---

## 💬 常见问题

**Q: BBR v3 和 BBR v2 有什么区别？**  
A: BBR v3 改进了拥塞窗口计算，减少了丢包，提升了跨国高延迟链路的性能。

**Q: ARM 服务器能用吗？**  
A: 可以，脚本会自动检测 ARM64 架构并调用专用安装脚本。

**Q: 虚拟内存（SWAP）应该设置多大？**  
A: 使用脚本的智能计算功能（菜单选项 5/6），会根据物理内存自动推荐最佳大小。

**Q: 安装失败怎么办？**  
A: 检查磁盘空间是否充足（≥3GB）、网络连接是否正常、系统是否为 Debian/Ubuntu。

**Q: 我的VPS只有1GB内存，应该选哪个方案？**  
A: 强烈推荐选择 **低配优化模式**（选项3）💡。这个方案专为512MB-1GB内存设计，保留了核心优化（BBR + fq + FastOpen + slow_start_after_idle=0），但大幅降低资源消耗（8MB缓冲区，swappiness=10），稳定性最高，性能仍可提升15-25%。

**Q: Reality终极优化和星辰大海有什么区别？**  
A: Reality终极优化是基于星辰大海深度改进的新方案，性能提升5-10%，资源消耗降低25%，参数更科学（如netdev_max_backlog从250000降到5000），新增Reality特有优化（tcp_notsent_lowat等），适配性更强（2GB内存即可）。推荐≥2GB内存的VPS使用。

**Q: 三个优化方案怎么选？**  
A: 根据内存选择：**512MB-1GB → 低配优化（选项3）💡** | **2-4GB → Reality终极（选项2）🏆** | **≥4GB → 星辰大海（选项1）**

**Q: 内核参数优化是否会永久生效？**  
A: 不会。所有方案都是临时生效（使用sysctl -w），重启后自动还原。这样设计是为了安全测试，避免永久修改系统配置。

---

## 🤝 参考资料

- **XanMod 官网**: [https://xanmod.org/](https://xanmod.org/)
- **BBR v3**: [Google BBR v3](https://github.com/google/bbr)
- **Xray 文档**: [https://xtls.github.io/](https://xtls.github.io/)
- **CAKE 文档**: [Common Applications Kept Enhanced](https://www.bufferbloat.net/projects/codel/wiki/Cake/)

---

## 🌐 相关链接

- **GitHub**: [https://github.com/Eric86777/vps-tcp-tune](https://github.com/Eric86777/vps-tcp-tune)
- **问题反馈**: [Issues](https://github.com/Eric86777/vps-tcp-tune/issues)
- **视频教程**: [B站](https://www.bilibili.com/video/BV14K421x7BS)

---

## 📝 更新日志

<details>
<summary>查看完整更新日志（点击展开）</summary>

### v3.0.3 (2025-10-20) - iperf3 网络测试增强版

- 📊 **新增 iperf3 单线程网络测试功能** 🏆 **推荐（网络测试必备）**
  - **交互式测试**：手动输入目标IP、选择测试方向、自定义测试时长
  - **双向测试**：支持上传测试（本机→远程）和下载测试（远程→本机）
  - **智能评价**：自动分析重传次数，给出连接质量评价（优秀/良好/一般/较差）
  - **美观报告**：彩色输出测试结果，包含带宽/传输量/重传次数/质量评价
  - **自动安装**：检测 iperf3 并自动安装
  - 菜单位置：选项 22（未安装）/ 23（已安装）

- 🎯 **使用场景优化**
  - Realm中转场景：测试前置链路（9929 → 中转机）性能
  - 直连节点场景：测试节点服务器（9929 → 落地节点）性能
  - 配置验证：对比不同配置下的真实性能差异

- 🚀 **用户体验提升**
  - 一键安装方式调整：快捷别名（bbr）提升为首选推荐方式
  - README优化：BBR快捷方式置顶，其他方式折叠
  - 安装优势说明：3个字符启动、自动获取最新版、支持bash/zsh

- 📋 **菜单系统更新**
  - 所有后续选项序号 +1（23→24, 24→25...）
  - 已安装/未安装两种状态完整映射
  - 菜单对照表全面更新（22/23: iperf3单线程测试）

- 📚 **文档完善**
  - README 新增详细的 iperf3 功能说明
  - 完整的使用流程、测试场景和结果示例
  - 连接质量评价标准详细说明
  - 前置要求和优势对比

### v3.0.2 (2025-10-18) - Debian12 智能调优版

- 🎯 **新增 Debian12 智能调优功能** 🏆 **推荐（自动化首选）**
  - **智能 BDP 计算**：自动根据带宽和延迟计算最优缓冲区
  - **内存保护机制**：缓冲区不超过系统内存 10%，避免 OOM
  - **自动网络检测**：ping 8.8.8.8 获取真实 RTT（失败则用 50ms）
  - **冲突配置清理**：自动备份并清理旧配置，避免参数冲突
  - **安全验证**：< 512MB 内存自动拒绝，< 1GB 警告
  - 菜单位置：选项 3（未安装）/ 4（已安装）

- 📊 **计算逻辑优化**
  - BDP = 带宽 × RTT / 8（默认 1000Mbps）
  - 桶值选择：4MB / 8MB / 16MB / 32MB / 64MB
  - 内存限制：max_bucket = 系统内存 × 10%
  - 配置文件：`/etc/sysctl.d/999-net-bbr-fq.conf`

- 🎨 **输出优化**
  - 彩色输出（绿色/黄色/红色）便于识别
  - 详细的步骤说明和验证结果
  - 最终配置一键查看

- 📋 **菜单系统更新**
  - 所有后续选项序号 +1（3→4, 4→5...）
  - 已安装/未安装两种状态完整映射
  - 菜单对照表全面更新

- 📚 **文档更新**
  - README 新增详细功能说明
  - 配置示例和计算流程
  - 适用场景和优势对比
  - 注意事项和使用建议

### v3.0.1 (2025-10-17) - 星辰大海优化版 + CAKE兼容

- 🌟 **星辰大海模式重大优化**
  - 文件描述符：100万 → 13万（降低内存占用）
  - swappiness：1 → 5（更安全，避免OOM）
  - netdev_max_backlog：250000 → 5000（修正过激值）
  - **CAKE队列兼容**：不再强制覆盖用户的CAKE设置 ✓
  - 删除13个无用参数（tcp_window_scaling、tcp_timestamps等默认值）
  - 适用内存：≥4GB → ≥2GB（适配性更强）
  - 评分：23/25 → 24/25 🏆

- ✅ **所有方案CAKE兼容**
  - 星辰大海、Reality终极、低配优化均支持CAKE
  - 检测当前队列算法，保持用户设置不变
  - 完美适配推荐流程：BBR v3 → CAKE → Reality调优

- 📊 **三方案重新定位**
  - 星辰大海：13万fd + 16MB缓冲 + CAKE兼容，≥2GB推荐 🏆
  - Reality终极：50万fd + 12MB缓冲 + Reality特有优化，≥2GB高性能
  - 低配优化：6.5万fd + 8MB缓冲 + 核心优化保留，1GB推荐 💡

### v3.0.0 (2025-10-17) - Reality Ultimate Optimization

- 🎯 **内核参数优化大幅精简与扩展**
  - 删除了5个通用优化模式（高性能、均衡、网站、直播、游戏服）
  - 专注于Reality节点优化，提供3种专用模式
  - 覆盖512MB-8GB+所有VPS配置
  - 菜单从7个选项精简到3个选项

- 🚀 **新增Reality终极优化模式** 🏆 **推荐（2GB+）**
  - 基于星辰大海深度改进的新方案
  - 性能提升：比星辰大海提升5-10%
  - 资源优化：资源消耗降低25%
  - 参数更科学：修正netdev_max_backlog等过高参数
  - Reality特有优化：新增tcp_notsent_lowat、更短的fin_timeout等
  - 适配性更强：2GB内存即可使用（vs 星辰大海需要4GB+）
  - 评分：⭐⭐⭐⭐⭐ (24/25分)

- 💡 **新增低配优化模式** 💡 **推荐（1GB）**
  - 专为512MB-1GB内存VPS设计
  - 核心优化保留：BBR + fq + FastOpen + slow_start_after_idle=0
  - 6.5万文件描述符 + 8MB缓冲区
  - swappiness=10（安全值）
  - 性能提升15-25%，稳定性最高
  - 评分：⭐⭐⭐⭐ (20/25分)

- ⭐ **保留星辰大海ヾ优化模式**
  - 参数最全面的Reality优化方案
  - 100万文件描述符 + 16MB缓冲区
  - 适合高配置VPS（≥4GB内存）
  - 评分：⭐⭐⭐⭐⭐ (23/25分)

- 📋 **新菜单界面**
  - 标题：Linux系统内核参数优化 - Reality专用调优
  - 明确标注：所有方案临时生效（重启后自动还原）
  - 清晰展示每个方案的适用场景和评分
  - 1GB内存用户有明确推荐方案 💡

- 📊 **三方案对比**
  - 文件描述符：星辰大海100万 vs Reality终极50万 vs 低配6.5万
  - TCP缓冲区：星辰大海16MB vs Reality终极12MB vs 低配8MB
  - 内存需求：星辰大海≥4GB vs Reality终极≥2GB vs 低配512MB-1GB
  - swappiness：星辰大海1 vs Reality终极5 vs 低配10
  - 适用场景：高配VPS vs 中配VPS vs 低配VPS（1GB推荐）

- ✅ **配置特性**
  - 所有方案都是临时生效，使用sysctl -w设置
  - 重启后自动还原，安全可靠
  - 适合测试和临时优化场景
  - 无需担心永久修改系统配置

### v2.8.0 (2025-01-16) - Sub-Store Multi-Instance Management

- 📦 **新增 Sub-Store 多实例管理功能**
  - 基于 Docker Compose 的完整生命周期管理
  - 支持安装、更新、卸载、查看多个独立实例
  - **自定义访问路径**（支持随机生成或自定义，如 `/my-subs`）
  - 智能端口冲突检测（后端 3001 + 前端 9876）
  - Docker/Docker Compose 依赖自动安装（国内/国外镜像可选）
  - 菜单位置：选项 30（未安装）/ 32（已安装）

- 🎯 **交互式配置向导（核心亮点）**
  - 🌐 **Cloudflare Tunnel 自动化部署**
    - 自动下载并安装 `cloudflared`（支持 x86_64/aarch64）
    - 引导登录 Cloudflare 账户
    - 自动创建隧道和配置 DNS 路由
    - 生成配置文件并创建 systemd 服务
    - 自动启动服务并验证状态
    - 完成后显示访问地址和管理命令
  - ⚙️ **灵活选择**
    - 可选择跳过配置，生成模板供稍后手动配置
    - 配置失败时提供详细错误信息和手动修复指南

- 🔧 **反向代理配置自动生成**
  - 自动生成 Cloudflare Tunnel 配置文件
  - 前后端共用单端口配置（由 SUB_STORE_BACKEND_API_PORT 指定）
  - 配置文件保存在 `/root/sub-store-cf-tunnel-{实例编号}.yaml`
  - 自动处理 SSL/TLS（由 Cloudflare 提供）

- 🎯 **核心特性**
  - 前后端分离架构（`xream/sub-store:http-meta` 镜像）
  - 监听本地 127.0.0.1（安全隔离，必须通过反向代理访问）
  - 配置持久化（独立 YAML 文件管理）
  - 数据目录独立（支持自定义或使用默认路径）
  - 完整的实例状态显示（运行中/已停止）

- 📋 **使用场景**
  - 为不同用户部署独立 Sub-Store 实例
  - 测试环境与生产环境分离
  - 不同订阅源使用不同实例
  - 负载分散到多个实例

- 📚 **文档完善**
  - README 新增详细的 Sub-Store 功能说明
  - 包含完整的安装流程、配置示例和常用命令
  - **交互式配置向导完整说明**
  - Cloudflare Tunnel 自动化配置指南
  - 多实例场景说明

### v2.7.0 (2025-10-14) - Realm Analysis & Connection Detection

- 🔍 **新增 Realm 转发连接分析工具**
  - 自动检测 Realm 进程并分析所有转发源
  - 智能识别纯IPv4和IPv4映射IPv6格式（`::ffff:`）
  - 自动查询IP归属地（国家/城市/ISP/AS号）
  - 实时统计连接数和协议分布
  - 4大交互功能：详细列表/导出报告/实时监控/特定IP分析
  - 菜单位置：选项 11（未安装）/ 12（已安装）

- 🌐 **IPv4/IPv6 连接检测工具升级**
  - 出站检测：验证本机到目标服务器的连接协议
  - 入站检测：验证来自源服务器的连接协议
  - 精确统计IPv4/IPv6连接数
  - 完美适配Realm转发场景验证
  - 菜单位置：选项 10（未安装）/ 11（已安装）

- 📋 **菜单系统更新**
  - 新增2个核心功能（Realm分析 + IPv4/IPv6检测）
  - 所有后续选项序号 +2（10→12, 11→13...）
  - 更新菜单对照表文档（MENU_TABLE.md）

- 📚 **文档全面更新**
  - README新增Realm分析功能详细说明
  - 完整示例输出和使用场景
  - 菜单对照表独立文档化

### v2.6.0 (2025-10-12) - Network Management Enhancement

- 🌐 **新增 IPv6 管理功能**
  - 临时禁用 IPv6（重启后自动恢复）
  - 永久禁用 IPv6（重启后仍生效）
  - 取消永久禁用（完全还原到执行前状态）
  - **核心特性**：智能状态备份与精确还原机制
  - 备份文件：`/etc/sysctl.d/.ipv6-state-backup.conf`
  - 配置文件：`/etc/sysctl.d/99-disable-ipv6.conf`
  - 确保"取消禁用"后系统恢复到"从未执行过"的状态

- 🔌 **新增临时 SOCKS5 代理配置功能**
  - 交互式配置代理服务器（IP、端口、认证）
  - 自动生成临时配置文件：`/tmp/socks5_proxy_YYYYMMDD_HHMMSS.sh`
  - 支持有认证和无认证两种模式
  - 使用 `source` 命令应用，重启后自动失效
  - 适合临时代理需求场景

- 📋 **菜单系统优化**
  - 新增2个系统设置选项（IPv6管理、SOCKS5代理配置）
  - 所有后续选项序号 +2（保持功能完整性）
  - XanMod已安装/未安装两种状态的菜单映射已更新

- 📚 **文档完善**
  - 新增《功能测试说明.md》- 详细测试步骤
  - 新增《实现总结.md》- 技术实现细节
  - README 功能说明全面更新

### v2.5.3 (2025-01-11) - SOCKS5 Proxy Deployment

- 🚀 **新增一键部署 SOCKS5 代理功能**
  - 基于 Sing-box 的独立 SOCKS5 代理服务
  - 智能检测 Sing-box 二进制程序
  - 7步自动化部署流程（检测→配置→验证→启动）
  - 支持用户名密码认证
  - 智能端口配置（随机生成或手动指定）
  - 独立服务管理（sbox-socks5）

- 🔧 **脚本执行错误修复**
  - 删除无效的 `--configure` 快捷命令
  - 修复 Xray 配置备份时间戳不匹配问题
  - 优化备份文件命名
  - 确保配置失败回滚时能正确找到备份文件

### v2.5.2 (2025-01-11) - Script Collection Reorganization

- 📂 **脚本合集顺序调整**
  - 调整第三方工具脚本的展示顺序，更符合使用优先级
  - F佬一键sing box脚本（从原25移至22）
  - 科技lion脚本（从原24移至23）
  - NS论坛的cake调优（从原22移至24）
  - 酷雪云脚本（从原23移至25）

### v2.5.1 (2025-01-11) - Menu Refinement Edition

- 🔄 **菜单项交换与重命名**
  - 交换"系统内核参数优化"和"CAKE调优"的位置
  - "单独cake脚本" → "NS论坛CAKE调优"
  - "Linux系统内核参数优化" → "科技lion高性能模式内核参数优化"

- 🎯 **优化理由**
  - 优先展示CAKE队列优化，更直接有效
  - 科技lion品牌化，提升辨识度
  - 保持菜单逻辑清晰，易于查找

[查看更多历史版本](https://github.com/Eric86777/vps-tcp-tune/releases)

</details>

---

## 📄 License

MIT

---

**⭐ 如果这个脚本对你有帮助，欢迎 Star！**
